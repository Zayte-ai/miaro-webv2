// MaisonMiaro E-commerce Database Schema
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================================
// AUTHENTICATION & USERS
// ================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  isAdmin   Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authentication
  passwordHash String
  emailVerified DateTime?
  emailVerificationToken String?
  resetPasswordToken String?
  resetPasswordExpires DateTime?

  // Profile
  avatar String?
  dateOfBirth DateTime?
  
  // Addresses
  addresses Address[]
  
  // Orders
  orders Order[]
  
  // Wishlist
  wishlistItems WishlistItem[]
  
  // Reviews
  reviews Review[]

  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  type      AddressType @default(SHIPPING)
  firstName String
  lastName  String
  company   String?
  street    String
  street2   String?
  city      String
  state     String
  zipCode   String
  country   String   @default("US")
  phone     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Order relations
  ordersBilling Order[] @relation("BillingAddress")
  ordersShipping Order[] @relation("ShippingAddress")

  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  BOTH
}

// ================================
// PRODUCT CATALOG
// ================================

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  parentId    String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@map("categories")
}

model Product {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String
  shortDescription String?
  sku           String?  @unique
  price         Float
  comparePrice  Float?
  costPrice     Float?
  trackInventory Boolean @default(true)
  
  // SEO
  metaTitle     String?
  metaDescription String?
  
  // Media
  images        ProductImage[]
  imageFrames   Int           @default(35)
  model3d       String?
  
  // Organization
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id])
  
  // Variants
  variants      ProductVariant[]
  
  // Inventory
  inventory     ProductInventory?
  
  // Features
  isFeatured    Boolean  @default(false)
  isActive      Boolean  @default(true)
  publishedAt   DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  orderItems    OrderItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]

  @@map("products")
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  url       String
  altText   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

model ProductVariant {
  id         String   @id @default(cuid())
  productId  String
  name       String
  sku        String?  @unique
  price      Float?
  comparePrice Float?
  sortOrder  Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Variant options (size, color, etc.)
  variantOptions VariantOption[]
  
  // Inventory
  inventory ProductVariantInventory?
  
  // Order items
  orderItems OrderItem[]

  @@map("product_variants")
}

model VariantOption {
  id              String         @id @default(cuid())
  productVariantId String
  optionId        String
  value           String
  
  productVariant  ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  option          Option         @relation(fields: [optionId], references: [id])

  @@unique([productVariantId, optionId])
  @@map("variant_options")
}

model Option {
  id         String   @id @default(cuid())
  name       String   @unique
  type       OptionType
  values     OptionValue[]
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  variantOptions VariantOption[]

  @@map("options")
}

model OptionValue {
  id        String   @id @default(cuid())
  optionId  String
  value     String
  label     String?
  hexCode   String?  // For colors
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  option Option @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@map("option_values")
}

enum OptionType {
  SIZE
  COLOR
  MATERIAL
  STYLE
  OTHER
}

model ProductInventory {
  id                String   @id @default(cuid())
  productId         String   @unique
  quantity          Int      @default(0)
  lowStockThreshold Int      @default(10)
  trackQuantity     Boolean  @default(true)
  allowBackorder    Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_inventory")
}

model ProductVariantInventory {
  id                String         @id @default(cuid())
  productVariantId  String         @unique
  quantity          Int            @default(0)
  lowStockThreshold Int            @default(10)
  trackQuantity     Boolean        @default(true)
  allowBackorder    Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  @@map("product_variant_inventory")
}

// ================================
// ORDERS & PAYMENTS
// ================================

model Order {
  id             String      @id @default(cuid())
  orderNumber    String      @unique
  userId         String?
  email          String
  
  // Addresses
  billingAddressId  String?
  shippingAddressId String?
  billingAddress    Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])
  shippingAddress   Address? @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  
  // Pricing
  subtotal       Float
  taxAmount      Float       @default(0)
  shippingAmount Float       @default(0)
  discountAmount Float       @default(0)
  totalAmount    Float
  
  // Status
  status         OrderStatus @default(PENDING)
  paymentStatus  PaymentStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)

  // Shipping Information
  trackingNumber    String?
  trackingCarrier   String?  @default("FedEx")
  shippingService   String?  // e.g., "FEDEX_GROUND", "FEDEX_2_DAY"
  shippingLabelUrl  String?  // URL to shipping label PDF
  shippedAt         DateTime?
  deliveredAt       DateTime?
  estimatedDelivery DateTime?

  // Metadata
  notes          String?
  tags           String? // Comma-separated tags for SQLite compatibility
  
  // Timestamps
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  canceledAt     DateTime?
  
  // Relations
  user           User?       @relation(fields: [userId], references: [id])
  items          OrderItem[]
  payments       Payment[]

  @@map("orders")
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  productId        String
  productVariantId String?
  quantity         Int
  price            Float
  totalPrice       Float
  createdAt        DateTime       @default(now())

  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  productVariant  ProductVariant? @relation(fields: [productVariantId], references: [id])

  @@map("order_items")
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String
  amount          Float
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)
  method          PaymentMethod
  gateway         String        // stripe, paypal, etc.
  gatewayTransactionId String?
  gatewayResponse Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  CANCELED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  APPLE_PAY
  GOOGLE_PAY
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

// ================================
// CUSTOMER ENGAGEMENT
// ================================

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  productId String
  rating    Int      // 1-5
  title     String?
  content   String?
  isVerifiedPurchase Boolean @default(false)
  isApproved Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("reviews")
}

// ================================
// ADMIN & SETTINGS
// ================================

model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         AdminRole @default(ADMIN)
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admins")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      SettingType @default(STRING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ================================
// CONTACT MESSAGES
// ================================

model ContactMessage {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String
  subject   String
  message   String
  isRead    Boolean  @default(false)
  isReplied Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_messages")
}
